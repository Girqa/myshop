<!DOCTYPE html>
<html lang="ru" xmlns:th="http://www.thymeleaf.org">
<head>
</head>
<body>

<header th:fragment="header"
        class="container-lg d-flex justify-content-lg-between align-items-center sticky-lg-top"
        style="background-color: #f5f5f5; height: 50px">

  <div class="block">
    <a th:href="@{/}">
      <button class="btn btn-primary">Главная</button>
    </a>
  </div>

  <div class="block" th:if="${#lists.contains(authorities, 'ROLE_USER') or #lists.contains(authorities, 'ROLE_ADMIN')}">
    <a th:href="@{/logout}">
      <button class="btn btn-primary">Выйти</button>
    </a>
  </div>

  <div class="block" th:if="${#lists.contains(authorities, 'ROLE_USER') or #lists.contains(authorities, 'ROLE_ADMIN')}">
    <span th:text="${username}"></span>
  </div>

  <div class="block" th:if="${#lists.contains(authorities, 'ROLE_ANONYMOUS')}">
    <a th:href="@{/login}">
      <button class="btn btn-primary">Войти</button>
    </a>
  </div>

  <div class="block" th:if="${#lists.contains(authorities, 'ROLE_USER')}">
    <div class="d-flex justify-content-end">

      <div class="block me-3" id="balance-placeholder">
        <div class="btn btn-warning"></div>
      </div>

      <div class="d-flex justify-content-end">
        <div class="block me-3">
          <a th:href="@{/bucket}">
            <button class="btn btn-primary">Корзина</button>
          </a>
        </div>

        <div class="block">
          <a th:href="@{/order/all}">
            <button class="btn btn-primary">Заказы</button>
          </a>
        </div>
      </div>
    </div>
  </div>
  <script th:if="${#lists.contains(authorities, 'ROLE_USER')}">
    let balanceWidget = document.querySelector('#balance-placeholder .btn');
    let IS_BALANCE_AVAILABLE = false;

    fetch("/api/v1/balance", {
      method: 'GET',
      headers: {
        'Content-Type': 'application/json'
      }
    }).then(response => {
      if (response.ok) {
        return response.text();
      } else {
        balanceWidget.textContent = `Баланс: не доступен`;
        balanceWidget.classList.add('disabled');
        throw Error('balance not found');
      }
    }).then(body => {
      IS_BALANCE_AVAILABLE = true;
      balanceWidget.textContent = `Баланс: ${body}`;
    }).catch()
  </script>
</header>

</body>
</html>